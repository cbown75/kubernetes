apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: pihole
resources:
  - ../../../../apps/nebula-sync-pihole1
  - sealed-secret.yaml
commonLabels:
  app.kubernetes.io/instance: nebula-sync-pihole1-korriban
  app.kubernetes.io/managed-by: flux
replacements:
  - source:
      kind: ConfigMap
      name: cluster-values
      namespace: flux-system
      fieldPath: data.pihole\.primary\.host
    targets:
      - select:
          kind: Deployment
          name: nebula-sync-pihole1
        fieldPaths:
          - spec.template.spec.initContainers.[name=setup-config].env.[name=PIHOLE_PRIMARY_HOST].value
  - source:
      kind: ConfigMap
      name: cluster-values
      namespace: flux-system
      fieldPath: data.pihole\.replica1\.host
    targets:
      - select:
          kind: Deployment
          name: nebula-sync-pihole1
        fieldPaths:
          - spec.template.spec.initContainers.[name=setup-config].env.[name=PIHOLE_REPLICA1_HOST].value
  - source:
      kind: ConfigMap
      name: cluster-values
      namespace: flux-system
      fieldPath: data.pihole\.replica2\.host
    targets:
      - select:
          kind: Deployment
          name: nebula-sync-pihole1
        fieldPaths:
          - spec.template.spec.initContainers.[name=setup-config].env.[name=PIHOLE_REPLICA2_HOST].value
  - source:
      kind: ConfigMap
      name: cluster-values
      namespace: flux-system
      fieldPath: data.pihole\.replica3\.host
    targets:
      - select:
          kind: Deployment
          name: nebula-sync-pihole1
        fieldPaths:
          - spec.template.spec.initContainers.[name=setup-config].env.[name=PIHOLE_REPLICA3_HOST].value
