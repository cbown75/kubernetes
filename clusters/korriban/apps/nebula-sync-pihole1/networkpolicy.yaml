apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: nebula-sync-pihole1-restrictive
  namespace: pihole
  labels:
    app.kubernetes.io/name: nebula-sync-pihole1
    app.kubernetes.io/instance: nebula-sync-pihole1
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: nebula-sync-pihole1
      app.kubernetes.io/instance: nebula-sync-pihole1
  policyTypes:
    - Egress
  egress:
    # Allow DNS queries to kube-system CoreDNS (required for domain resolution)
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
        - podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    # Allow HTTP access to specific PiHole server IPs ONLY
    - to:
        - ipBlock:
            cidr: 10.10.0.4/32 # pihole1 from CoreDNS config
      ports:
        - protocol: TCP
          port: 80
    - to:
        - ipBlock:
            cidr: 10.10.0.5/32 # pihole2 from CoreDNS config
      ports:
        - protocol: TCP
          port: 80
    - to:
        - ipBlock:
            cidr: 192.168.1.250/32 # pihole7 from CoreDNS config
      ports:
        - protocol: TCP
          port: 80
    - to:
        - ipBlock:
            cidr: 192.168.1.251/32 # pihole8 from CoreDNS config
      ports:
        - protocol: TCP
          port: 80

# Explicitly deny all other traffic (no additional egress rules)
# This blocks:
# - Communication with other pods in the cluster
# - Access to other external IPs
# - Access to other ports on allowed IPs
