apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: nebula-sync-pihole1
  namespace: flux-system
spec:
  interval: 5m0s
  chart:
    spec:
      chart: apps/nebula-sync-pihole1
      sourceRef:
        kind: GitRepository
        name: flux-system
        namespace: flux-system
      interval: 1m0s
      reconcileStrategy: Revision
  releaseName: nebula-sync-pihole1
  targetNamespace: pihole
  install:
    createNamespace: false
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
      remediateLastFailure: true
  rollback:
    timeout: 10m0s
    recreate: true
  values:
    # Nebula Sync Configuration
    nebulaSync:
      primary:
        url: "http://pihole1.home.cwbtech.net"
        passwordSecretName: "nebula-sync-pihole1-secrets"
        passwordSecretKey: "primary-password"
      replicas:
        urls:
          - "http://pihole2.home.cwbtech.net"
          - "http://pihole7.home.cwbtech.net"
          - "http://pihole8.home.cwbtech.net"
        passwordSecretName: "nebula-sync-pihole1-secrets"
        passwordSecretKeys:
          - "replica-password-1"
          - "replica-password-2"
          - "replica-password-3"
      config:
        fullSync: false
        cron: "*/5 * * * *"
        timezone: "America/Phoenix"
      dns:
        enabled: true
      dhcp:
        enabled: true
      ntp:
        enabled: true
      resolver:
        enabled: true
      database:
        enabled: true
      misc:
        enabled: false
      debug:
        enabled: true
      gravity:
        dhcpLeases: true
        group: true
        adList: true
        adListByGroup: true
        domainList: true
        domainListByGroup: true
        client: true
        clientByGroup: true
    # Back to hostNetwork - bypasses pod networking issues
    hostNetwork: true
    dnsPolicy: "None"
    dnsConfig:
      nameservers:
        - "10.10.4.4"
        - "10.10.4.5"
        - "10.10.4.1"
    # Sealed Secrets Configuration
    sealedSecrets:
      enabled: true
      secrets:
        nebula-sync-pihole1-secrets:
          primary-password: "AgBk0cmnEndOod26BTsPsS+F7/mVVIGWfqFv1dQEAghrXUGLmXDSVvB8I4oPJc1vKfKlf9Lnfwj+mfcjp/Mw07vTwDrH18KbRSbxpbjGzyCPuP3tcPVLo1KIDpFWjvaUxiTewm0Yym1TCSSqSiMwj4AUlbBhMkicn8uqMUANj3Ia2xyHAXNFHNqqNBrqiNPQyEQd9ICcyyM3XrZcLXJ6slg/rphrTnHFy+Q+mb/qpXWWj41+dv1XwuYGMMtruSstv2+JkIWOCp0+Xd69HxqYzpTYbVUxD7jiHk2RW8cjRwN6M8hHKeSevGeH1fIZ9drtcWUiN15UKP+FEgU6wgmL/9t/QzTC8cuxs6VyLElj9D9iLN7NKRI1nArU8eeuHAd2SNuqiPW3RtKlmDB+8ep02dmOLNd/SQHmU+DXXNRZ0+Xz1cR2PZ/gCZZeo3IfOm9+yRNVWxxGoI74Xz3agCGR0q7YZNiNYkSDBGrz9Fqqt7crRmbVd7HIwVQ+UnCdfihF9cHXrMPE6ljPyLYmjyH4ceCWXFklRiF1l9nkXj9Tea5Uju30sxKduygtpNd5rPR6YSGiGdW9OW7BnjmSCYSkqrfG1Wf/P8CkD+LKySTSRZQMp5VpH7RIJhKQ2/CP3U1G/pEEnYGC2tF9KyyrIU3zHNI5ii+DFoSIvyXZBuoK4t9OlRyTeYgcxqqL+1tNPgb/R+DD3u7nIlphXOS9"
          replica-password-1: "AgBk0cmnEndOod26BTsPsS+F7/mVVIGWfqFv1dQEAghrXUGLmXDSVvB8I4oPJc1vKfKlf9Lnfwj+mfcjp/Mw07vTwDrH18KbRSbxpbjGzyCPuP3tcPVLo1KIDpFWjvaUxiTewm0Yym1TCSSqSiMwj4AUlbBhMkicn8uqMUANj3Ia2xyHAXNFHNqqNBrqiNPQyEQd9ICcyyM3XrZcLXJ6slg/rphrTnHFy+Q+mb/qpXWWj41+dv1XwuYGMMtruSstv2+JkIWOCp0+Xd69HxqYzpTYbVUxD7jiHk2RW8cjRwN6M8hHKeSevGeH1fIZ9drtcWUiN15UKP+FEgU6wgmL/9t/QzTC8cuxs6VyLElj9D9iLN7NKRI1nArU8eeuHAd2SNuqiPW3RtKlmDB+8ep02dmOLNd/SQHmU+DXXNRZ0+Xz1cR2PZ/gCZZeo3IfOm9+yRNVWxxGoI74Xz3agCGR0q7YZNiNYkSDBGrz9Fqqt7crRmbVd7HIwVQ+UnCdfihF9cHXrMPE6ljPyLYmjyH4ceCWXFklRiF1l9nkXj9Tea5Uju30sxKduygtpNd5rPR6YSGiGdW9OW7BnjmSCYSkqrfG1Wf/P8CkD+LKySTSRZQMp5VpH7RIJhKQ2/CP3U1G/pEEnYGC2tF9KyyrIU3zHNI5ii+DFoSIvyXZBuoK4t9OlRyTeYgcxqqL+1tNPgb/R+DD3u7nIlphXOS9"
          replica-password-2: "AgBk0cmnEndOod26BTsPsS+F7/mVVIGWfqFv1dQEAghrXUGLmXDSVvB8I4oPJc1vKfKlf9Lnfwj+mfcjp/Mw07vTwDrH18KbRSbxpbjGzyCPuP3tcPVLo1KIDpFWjvaUxiTewm0Yym1TCSSqSiMwj4AUlbBhMkicn8uqMUANj3Ia2xyHAXNFHNqqNBrqiNPQyEQd9ICcyyM3XrZcLXJ6slg/rphrTnHFy+Q+mb/qpXWWj41+dv1XwuYGMMtruSstv2+JkIWOCp0+Xd69HxqYzpTYbVUxD7jiHk2RW8cjRwN6M8hHKeSevGeH1fIZ9drtcWUiN15UKP+FEgU6wgmL/9t/QzTC8cuxs6VyLElj9D9iLN7NKRI1nArU8eeuHAd2SNuqiPW3RtKlmDB+8ep02dmOLNd/SQHmU+DXXNRZ0+Xz1cR2PZ/gCZZeo3IfOm9+yRNVWxxGoI74Xz3agCGR0q7YZNiNYkSDBGrz9Fqqt7crRmbVd7HIwVQ+UnCdfihF9cHXrMPE6ljPyLYmjyH4ceCWXFklRiF1l9nkXj9Tea5Uju30sxKduygtpNd5rPR6YSGiGdW9OW7BnjmSCYSkqrfG1Wf/P8CkD+LKySTSRZQMp5VpH7RIJhKQ2/CP3U1G/pEEnYGC2tF9KyyrIU3zHNI5ii+DFoSIvyXZBuoK4t9OlRyTeYgcxqqL+1tNPgb/R+DD3u7nIlphXOS9"
          replica-password-3: "AgBk0cmnEndOod26BTsPsS+F7/mVVIGWfqFv1dQEAghrXUGLmXDSVvB8I4oPJc1vKfKlf9Lnfwj+mfcjp/Mw07vTwDrH18KbRSbxpbjGzyCPuP3tcPVLo1KIDpFWjvaUxiTewm0Yym1TCSSqSiMwj4AUlbBhMkicn8uqMUANj3Ia2xyHAXNFHNqqNBrqiNPQyEQd9ICcyyM3XrZcLXJ6slg/rphrTnHFy+Q+mb/qpXWWj41+dv1XwuYGMMtruSstv2+JkIWOCp0+Xd69HxqYzpTYbVUxD7jiHk2RW8cjRwN6M8hHKeSevGeH1fIZ9drtcWUiN15UKP+FEgU6wgmL/9t/QzTC8cuxs6VyLElj9D9iLN7NKRI1nArU8eeuHAd2SNuqiPW3RtKlmDB+8ep02dmOLNd/SQHmU+DXXNRZ0+Xz1cR2PZ/gCZZeo3IfOm9+yRNVWxxGoI74Xz3agCGR0q7YZNiNYkSDBGrz9Fqqt7crRmbVd7HIwVQ+UnCdfihF9cHXrMPE6ljPyLYmjyH4ceCWXFklRiF1l9nkXj9Tea5Uju30sxKduygtpNd5rPR6YSGiGdW9OW7BnjmSCYSkqrfG1Wf/P8CkD+LKySTSRZQMp5VpH7RIJhKQ2/CP3U1G/pEEnYGC2tF9KyyrIU3zHNI5ii+DFoSIvyXZBuoK4t9OlRyTeYgcxqqL+1tNPgb/R+DD3u7nIlphXOS9"
    # Security Configuration
    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 65534
      runAsGroup: 65534
      fsGroup: 65534
      seccompProfile:
        type: RuntimeDefault
    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop:
          - ALL
    # Resource Configuration
    resources:
      limits:
        memory: "256Mi"
        cpu: "200m"
      requests:
        memory: "128Mi"
        cpu: "100m"
    # NetworkPolicy disabled - not needed with hostNetwork
    networkPolicy:
      enabled: false
    # Service Configuration
    service:
      enabled: false
  dependsOn:
    - name: sealed-secrets
      namespace: kube-system
