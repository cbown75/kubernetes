apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: nebula-sync-pihole1
  namespace: flux-system
spec:
  interval: 5m0s
  chart:
    spec:
      chart: apps/nebula-sync-pihole1
      sourceRef:
        kind: GitRepository
        name: flux-system
        namespace: flux-system
      interval: 1m0s
      reconcileStrategy: Revision
  releaseName: nebula-sync-pihole1
  targetNamespace: pihole
  install:
    createNamespace: false
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
      remediateLastFailure: true
  rollback:
    timeout: 10m0s
    recreate: true
  values:
    # Nebula Sync Configuration
    nebulaSync:
      primary:
        url: "http://pihole1.home.cwbtech.net"
        passwordSecretName: "nebula-sync-pihole1-secrets"
        passwordSecretKey: "primary-password"
      replicas:
        urls:
          - "http://pihole2.home.cwbtech.net"
          - "http://pihole7.home.cwbtech.net"
          - "http://pihole8.home.cwbtech.net"
        passwordSecretName: "nebula-sync-pihole1-secrets"
        passwordSecretKeys:
          - "replica-password-1"
          - "replica-password-2"
          - "replica-password-3"
      config:
        fullSync: false
        cron: "*/5 * * * *"
        timezone: "America/Phoenix"
      dns:
        enabled: true
      dhcp:
        enabled: true
      ntp:
        enabled: true
      resolver:
        enabled: true
      database:
        enabled: true
      misc:
        enabled: false
      debug:
        enabled: false
      gravity:
        dhcpLeases: true
        group: true
        adList: true
        adListByGroup: true
        domainList: true
        domainListByGroup: true
        client: true
        clientByGroup: true
    # Sealed Secrets Configuration
    sealedSecrets:
      enabled: true
      secrets:
        nebula-sync-pihole1-secrets:
          primary-password: "AgAvX0u3gF0IvtiuyMFDOVp7r2akpgBTwcBd4Qox8Esj3R45UKr3no+FZRoshMV9cfsvVJ/pqasR6GEGLRzyvGAP0Wqm1JVeBOnz8SGl45TPw2rMn+NkTZI91QK1I0GDoP09gTM9JPt/ysiR/AY4i3L4s8pjah6mGocImXELOcVczvDLc5eC8bYnWkkOlrOR9m7l5WS9N9Ph1cvVihcM870Dfr5saC4MrD7i4xML8h4hl3N4/pZl87szCIXQuuvMixez9GH9YpCIOvG3ZVrGePxcYj9pQKqwGDaBtfqNyJBhqTRj+ycCurOWfeKnRxjJ6BY487zEtltnoV9LAe5xmItzMIA1qP+m2yM0X6oD73VXwxpT6x/1KeVJ3V0SHi4CCM0gPnho9ckJfYuJ/aR9guQArMc"
          replica-password-1: "AgAvX0u3gF0IvtiuyMFDOVp7r2akpgBTwcBd4Qox8Esj3R45UKr3no+FZRoshMV9cfsvVJ/pqasR6GEGLRzyvGAP0Wqm1JVeBOnz8SGl45TPw2rMn+NkTZI91QK1I0GDoP09gTM9JPt/ysiR/AY4i3L4s8pjah6mGocImXELOcVczvDLc5eC8bYnWkkOlrOR9m7l5WS9N9Ph1cvVihcM870Dfr5saC4MrD7i4xML8h4hl3N4/pZl87szCIXQuuvMixez9GH9YpCIOvG3ZVrGePxcYj9pQKqwGDaBtfqNyJBhqTRj+ycCurOWfeKnRxjJ6BY487zEtltnoV9LAe5xmItzMIA1qP+m2yM0X6oD73VXwxpT6x/1KeVJ3V0SHi4CCM0gPnho9ckJfYuJ/aR9guQArMc"
          replica-password-2: "AgAvX0u3gF0IvtiuyMFDOVp7r2akpgBTwcBd4Qox8Esj3R45UKr3no+FZRoshMV9cfsvVJ/pqasR6GEGLRzyvGAP0Wqm1JVeBOnz8SGl45TPw2rMn+NkTZI91QK1I0GDoP09gTM9JPt/ysiR/AY4i3L4s8pjah6mGocImXELOcVczvDLc5eC8bYnWkkOlrOR9m7l5WS9N9Ph1cvVihcM870Dfr5saC4MrD7i4xML8h4hl3N4/pZl87szCIXQuuvMixez9GH9YpCIOvG3ZVrGePxcYj9pQKqwGDaBtfqNyJBhqTRj+ycCurOWfeKnRxjJ6BY487zEtltnoV9LAe5xmItzMIA1qP+m2yM0X6oD73VXwxpT6x/1KeVJ3V0SHi4CCM0gPnho9ckJfYuJ/aR9guQArMc"
          replica-password-3: "AgAvX0u3gF0IvtiuyMFDOVp7r2akpgBTwcBd4Qox8Esj3R45UKr3no+FZRoshMV9cfsvVJ/pqasR6GEGLRzyvGAP0Wqm1JVeBOnz8SGl45TPw2rMn+NkTZI91QK1I0GDoP09gTM9JPt/ysiR/AY4i3L4s8pjah6mGocImXELOcVczvDLc5eC8bYnWkkOlrOR9m7l5WS9N3R45UKr3no+FZRoshMV9cfsvVJ/pqasR6GEGLRzyvGAP0Wqm1JVeBOnz8SGl45TPw2rMn+NkTZI91QK1I0GDoP09gTM9JPt/ysiR/AY4i3L4s8pjah6mGocImXELOcVczvDLc5eC8bYnWkkOlrOR9m7l5WS9N9Ph1cvVihcM870Dfr5saC4MrD7i4xML8h4hl3N4/pZl87szCIXQuuvMixez9GH9YpCIOvG3ZVrGePxcYj9pQKqwGDaBtfqNyJBhqTRj+ycCurOWfeKnRxjJ6BY487zEtltnoV9LAe5xmItzMIA1qP+m2yM0X6oD73VXwxpT6x/1KeVJ3V0SHi4CCM0gPnho9ckJfYuJ/aR9guQArMc"
    # Security Configuration
    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 65534
      runAsGroup: 65534
      fsGroup: 65534
      seccompProfile:
        type: RuntimeDefault
    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop:
          - ALL
    # Resource Configuration
    resources:
      limits:
        memory: "256Mi"
        cpu: "200m"
      requests:
        memory: "128Mi"
        cpu: "100m"
    # Network Policy
    networkPolicy:
      enabled: true
      egress:
        - to: []
          ports:
            - protocol: UDP
              port: 53
            - protocol: TCP
              port: 53
        - to: []
          ports:
            - protocol: TCP
              port: 80
    # Service Configuration
    service:
      enabled: false
  dependsOn:
    - name: sealed-secrets
      namespace: kube-system
