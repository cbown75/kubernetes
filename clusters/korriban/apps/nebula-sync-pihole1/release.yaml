apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: nebula-sync-pihole1
  namespace: flux-system
spec:
  interval: 5m0s
  chart:
    spec:
      chart: apps/nebula-sync-pihole1
      sourceRef:
        kind: GitRepository
        name: flux-system
        namespace: flux-system
      interval: 1m0s
      reconcileStrategy: Revision
  releaseName: nebula-sync-pihole1
  targetNamespace: pihole
  install:
    createNamespace: false
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
      remediateLastFailure: true
  rollback:
    timeout: 10m0s
    recreate: true
  values:
    # Nebula Sync Configuration
    nebulaSync:
      primary:
        url: "http://pihole1.home.cwbtech.net"
        passwordSecretName: "nebula-sync-pihole1-secrets"
        passwordSecretKey: "primary-password"
      replicas:
        urls:
          - "http://pihole2.home.cwbtech.net"
          - "http://pihole7.home.cwbtech.net"
          - "http://pihole8.home.cwbtech.net"
        passwordSecretName: "nebula-sync-pihole1-secrets"
        passwordSecretKeys:
          - "replica-password-1"
          - "replica-password-2"
          - "replica-password-3"
      config:
        fullSync: false
        cron: "*/5 * * * *"
        timezone: "America/Phoenix"
      dns:
        enabled: true
      dhcp:
        enabled: true
      ntp:
        enabled: true
      resolver:
        enabled: true
      database:
        enabled: true
      misc:
        enabled: false
      debug:
        enabled: true
      gravity:
        dhcpLeases: true
        group: true
        adList: true
        adListByGroup: true
        domainList: true
        domainListByGroup: true
        client: true
        clientByGroup: true
    # Back to hostNetwork - bypasses pod networking issues
    hostNetwork: true
    dnsPolicy: "None"
    dnsConfig:
      nameservers:
        - "10.10.4.4"
        - "10.10.4.5"
        - "10.10.4.1"
    # Sealed Secrets Configuration
    sealedSecrets:
      enabled: true
      secrets:
        nebula-sync-pihole1-secrets:
          primary-password: "AgDyN8QseJtSO8NheFE30sH8XXBryhlYUUOE6t0TRxkmJj22+W77RJG+AT3iBk/Y5MqCxr865s3WJ3XtPkhAtFXj/S02M1BJHHf+yvZnzanihA36X6cVKyNQpUrmnycAWwTPmxojYKw27Vk6b9ormTf5bhAIKK1Emyp/rCAd//SBiPRbAx0eXzi54c7UTINzWU+Za6mjzN6k+B4q7PR6RFV4kjc3ZqQpJRzE307A4PJKvNwHAMOXkOkxNSt+AZhvhmRNH90ofqVXOm+cQwoiaKCnsjGPg9qrL20mOmbv1lPL4abEy2NbubK6J/F58X6lzDSG5PresoHhy452dUOwA0TojdpILygHscSx5XgRYSGjgQ9YctqgS62lwmONwaHIr94GexMn2aP8t6E9SwFwO2Ou2UWVBn9co98CE9UtVTugYoQvTVfZBoCnqVO81844pR5kRCcIUDZ6ipBcgLDE0lKGTl3/h0XwIvOa04Qs1dprHsw8gSjlAIMlNceqmM7mi2WHfVayhVt5mYujaLkI+J91bCBFP8h9Z3XNXLRXthWqqhOGfN/TSPhx7SjJE81ue5igEhR+nypXsGJXDeCw2oMG/2SoHJmSHxkNDWpBW8ch/cXWR3s2fZViAnZenwScZLA2J8yyZf9wZjm+06PH6CoX5kO1nY3NT6SMAQNI7eWjPDqu7ve9SSOvQj4d4aBIiTCqfixf+CuGN56XOU6GBuCYUws9fE3Uzu0jDn5JBJaJ9jZpjYDvJANG3jaHng=="
          replica-password-1: "AgDyN8QseJtSO8NheFE30sH8XXBryhlYUUOE6t0TRxkmJj22+W77RJG+AT3iBk/Y5MqCxr865s3WJ3XtPkhAtFXj/S02M1BJHHf+yvZnzanihA36X6cVKyNQpUrmnycAWwTPmxojYKw27Vk6b9ormTf5bhAIKK1Emyp/rCAd//SBiPRbAx0eXzi54c7UTINzWU+Za6mjzN6k+B4q7PR6RFV4kjc3ZqQpJRzE307A4PJKvNwHAMOXkOkxNSt+AZhvhmRNH90ofqVXOm+cQwoiaKCnsjGPg9qrL20mOmbv1lPL4abEy2NbubK6J/F58X6lzDSG5PresoHhy452dUOwA0TojdpILygHscSx5XgRYSGjgQ9YctqgS62lwmONwaHIr94GexMn2aP8t6E9SwFwO2Ou2UWVBn9co98CE9UtVTugYoQvTVfZBoCnqVO81844pR5kRCcIUDZ6ipBcgLDE0lKGTl3/h0XwIvOa04Qs1dprHsw8gSjlAIMlNceqmM7mi2WHfVayhVt5mYujaLkI+J91bCBFP8h9Z3XNXLRXthWqqhOGfN/TSPhx7SjJE81ue5igEhR+nypXsGJXDeCw2oMG/2SoHJmSHxkNDWpBW8ch/cXWR3s2fZViAnZenwScZLA2J8yyZf9wZjm+06PH6CoX5kO1nY3NT6SMAQNI7eWjPDqu7ve9SSOvQj4d4aBIiTCqfixf+CuGN56XOU6GBuCYUws9fE3Uzu0jDn5JBJaJ9jZpjYDvJANG3jaHng=="
          replica-password-2: "AgDyN8QseJtSO8NheFE30sH8XXBryhlYUUOE6t0TRxkmJj22+W77RJG+AT3iBk/Y5MqCxr865s3WJ3XtPkhAtFXj/S02M1BJHHf+yvZnzanihA36X6cVKyNQpUrmnycAWwTPmxojYKw27Vk6b9ormTf5bhAIKK1Emyp/rCAd//SBiPRbAx0eXzi54c7UTINzWU+Za6mjzN6k+B4q7PR6RFV4kjc3ZqQpJRzE307A4PJKvNwHAMOXkOkxNSt+AZhvhmRNH90ofqVXOm+cQwoiaKCnsjGPg9qrL20mOmbv1lPL4abEy2NbubK6J/F58X6lzDSG5PresoHhy452dUOwA0TojdpILygHscSx5XgRYSGjgQ9YctqgS62lwmONwaHIr94GexMn2aP8t6E9SwFwO2Ou2UWVBn9co98CE9UtVTugYoQvTVfZBoCnqVO81844pR5kRCcIUDZ6ipBcgLDE0lKGTl3/h0XwIvOa04Qs1dprHsw8gSjlAIMlNceqmM7mi2WHfVayhVt5mYujaLkI+J91bCBFP8h9Z3XNXLRXthWqqhOGfN/TSPhx7SjJE81ue5igEhR+nypXsGJXDeCw2oMG/2SoHJmSHxkNDWpBW8ch/cXWR3s2fZViAnZenwScZLA2J8yyZf9wZjm+06PH6CoX5kO1nY3NT6SMAQNI7eWjPDqu7ve9SSOvQj4d4aBIiTCqfixf+CuGN56XOU6GBuCYUws9fE3Uzu0jDn5JBJaJ9jZpjYDvJANG3jaHng=="
          replica-password-3: "AgDyN8QseJtSO8NheFE30sH8XXBryhlYUUOE6t0TRxkmJj22+W77RJG+AT3iBk/Y5MqCxr865s3WJ3XtPkhAtFXj/S02M1BJHHf+yvZnzanihA36X6cVKyNQpUrmnycAWwTPmxojYKw27Vk6b9ormTf5bhAIKK1Emyp/rCAd//SBiPRbAx0eXzi54c7UTINzWU+Za6mjzN6k+B4q7PR6RFV4kjc3ZqQpJRzE307A4PJKvNwHAMOXkOkxNSt+AZhvhmRNH90ofqVXOm+cQwoiaKCnsjGPg9qrL20mOmbv1lPL4abEy2NbubK6J/F58X6lzDSG5PresoHhy452dUOwA0TojdpILygHscSx5XgRYSGjgQ9YctqgS62lwmONwaHIr94GexMn2aP8t6E9SwFwO2Ou2UWVBn9co98CE9UtVTugYoQvTVfZBoCnqVO81844pR5kRCcIUDZ6ipBcgLDE0lKGTl3/h0XwIvOa04Qs1dprHsw8gSjlAIMlNceqmM7mi2WHfVayhVt5mYujaLkI+J91bCBFP8h9Z3XNXLRXthWqqhOGfN/TSPhx7SjJE81ue5igEhR+nypXsGJXDeCw2oMG/2SoHJmSHxkNDWpBW8ch/cXWR3s2fZViAnZenwScZLA2J8yyZf9wZjm+06PH6CoX5kO1nY3NT6SMAQNI7eWjPDqu7ve9SSOvQj4d4aBIiTCqfixf+CuGN56XOU6GBuCYUws9fE3Uzu0jDn5JBJaJ9jZpjYDvJANG3jaHng=="
    # Security Configuration
    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 65534
      runAsGroup: 65534
      fsGroup: 65534
      seccompProfile:
        type: RuntimeDefault
    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop:
          - ALL
    # Resource Configuration
    resources:
      limits:
        memory: "256Mi"
        cpu: "200m"
      requests:
        memory: "128Mi"
        cpu: "100m"
    # NetworkPolicy disabled - not needed with hostNetwork
    networkPolicy:
      enabled: false
    # Service Configuration
    service:
      enabled: false
  dependsOn:
    - name: sealed-secrets
      namespace: kube-system
