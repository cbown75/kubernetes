---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: alloy
  namespace: monitoring
  labels:
    app.kubernetes.io/name: alloy
    app.kubernetes.io/part-of: monitoring-stack
spec:
  targetNamespace: monitoring
  dependsOn:
    - name: loki
      namespace: monitoring
    - name: prometheus
      namespace: monitoring
  interval: 10m
  timeout: 10m
  chart:
    spec:
      chart: alloy
      version: "0.12.x"
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
      interval: 5m

  install:
    createNamespace: false
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  rollback:
    recreate: true
    force: true

  values:
    controller:
      type: "daemonset"

    alloy:
      configMap:
        name: alloy-config

    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 200m
        memory: 256Mi

    securityContext:
      runAsUser: 65534
      runAsGroup: 65534
      runAsNonRoot: true
      capabilities:
        add:
          - DAC_READ_SEARCH
        drop:
          - ALL
      readOnlyRootFilesystem: true
      allowPrivilegeEscalation: false

    podSecurityContext:
      fsGroup: 65534
      seccompProfile:
        type: RuntimeDefault

    hostNetwork: true
    hostPID: true

    mounts:
      varlog: true
      dockercontainers: false

    extraVolumes:
      - name: proc
        hostPath:
          path: /proc
      - name: sys
        hostPath:
          path: /sys
      - name: root
        hostPath:
          path: /
      - name: positions
        nfs:
          server: holocron.home.cwbtech.net
          path: /volume1/kubernetes/alloy-positions

    extraVolumeMounts:
      - name: proc
        mountPath: /host/proc
        readOnly: true
      - name: sys
        mountPath: /host/sys
        readOnly: true
      - name: root
        mountPath: /host/root
        readOnly: true
        mountPropagation: HostToContainer
      - name: positions
        mountPath: /var/lib/alloy

    extraArgs:
      - --server.http.listen-addr=0.0.0.0:12345
      - --storage.path=/var/lib/alloy

    extraEnv:
      - name: HOSTNAME
        valueFrom:
          fieldRef:
            fieldPath: spec.nodeName

    serviceMonitor:
      enabled: true
      additionalLabels:
        app.kubernetes.io/part-of: monitoring-stack
        release: prometheus

    tolerations:
      - operator: Exists
        effect: NoSchedule

    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: kubernetes.io/os
                  operator: In
                  values:
                    - linux

    updateStrategy:
      type: RollingUpdate
      rollingUpdate:
        maxUnavailable: 1

    rbac:
      create: true

    serviceAccount:
      create: true
      name: alloy
