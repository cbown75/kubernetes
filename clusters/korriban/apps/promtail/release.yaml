---
apiVersion: source.toolkit.fluxcd.io/v1beta2
kind: HelmRepository
metadata:
  name: grafana
  namespace: flux-system
spec:
  interval: 24h
  url: https://grafana.github.io/helm-charts

---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: promtail
  namespace: flux-system
spec:
  targetNamespace: monitoring
  dependsOn:
    - name: loki
      namespace: flux-system
  interval: 10m
  timeout: 10m
  chart:
    spec:
      chart: promtail
      version: "6.15.x"
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
      interval: 5m

  install:
    createNamespace: false
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  rollback:
    recreate: true
    force: true

  values:
    # DaemonSet configuration - runs on every node
    daemonset:
      enabled: true

    # Resources for DaemonSet pods
    resources:
      limits:
        cpu: 200m
        memory: 128Mi
      requests:
        cpu: 100m
        memory: 64Mi

    # Security context
    securityContext:
      runAsUser: 0 # Required to read log files
      runAsGroup: 0
      fsGroup: 0
      privileged: false
      allowPrivilegeEscalation: false
      capabilities:
        drop:
          - ALL
        add:
          - DAC_READ_SEARCH # Required to read log files
      readOnlyRootFilesystem: true

    # No secrets needed - all internal cluster communication
    config:
      clients:
        - url: http://loki.monitoring.svc.cluster.local:3100/loki/api/v1/push
          tenant_id: ""

      positions:
        filename: /tmp/positions.yaml

      server:
        http_listen_port: 3101
        grpc_listen_port: 0

      scrape_configs:
        # Kubernetes pod logs
        - job_name: kubernetes-pods
          kubernetes_sd_configs:
            - role: pod
          pipeline_stages:
            - cri: {}
          relabel_configs:
            - source_labels:
                - __meta_kubernetes_pod_controller_name
              regex: "([0-9a-z-.]+?)(-[0-9a-f]{8,10})?"
              action: replace
              target_label: __tmp_controller_name
            - source_labels:
                - __meta_kubernetes_pod_label_app_kubernetes_io_name
                - __meta_kubernetes_pod_label_app
                - __tmp_controller_name
                - __meta_kubernetes_pod_name
              regex: "(^[0-9a-z-.]+|;[0-9a-z-.]+|;[0-9a-z-.]+|;[0-9a-z-.]+).*"
              action: replace
              target_label: app
            - source_labels:
                - __meta_kubernetes_pod_label_app_kubernetes_io_version
                - __meta_kubernetes_pod_label_version
              regex: "(^[0-9a-z-.]+|;[0-9a-z-.]+).*"
              action: replace
              target_label: version
            - action: replace
              source_labels:
                - __meta_kubernetes_namespace
              target_label: namespace
            - action: replace
              source_labels:
                - __meta_kubernetes_pod_name
              target_label: pod
            - action: replace
              source_labels:
                - __meta_kubernetes_pod_container_name
              target_label: container
            - action: replace
              replacement: /var/log/pods/*$1/*.log
              separator: /
              source_labels:
                - __meta_kubernetes_pod_uid
                - __meta_kubernetes_pod_container_name
              target_label: __path__
            # Drop logs for system pods to reduce noise
            - action: drop
              regex: kube-system|flux-system|metallb-system
              source_labels:
                - __meta_kubernetes_namespace

        # Kubernetes events
        - job_name: kubernetes-events
          kubernetes_sd_configs:
            - role: pod
              namespaces:
                names:
                  - monitoring
                  - default
                  - kube-system
          pipeline_stages:
            - match:
                selector: '{job="kubernetes-events"}'
                stages:
                  - json:
                      expressions:
                        message: message
                        reason: reason
                        type: type
                  - labels:
                      reason:
                      type:
          relabel_configs:
            - source_labels: [__meta_kubernetes_pod_label_component]
              action: keep
              regex: kube-apiserver|kube-controller-manager|kube-scheduler

    # Service monitor for Prometheus
    serviceMonitor:
      enabled: true
      labels:
        app.kubernetes.io/part-of: monitoring-stack

    # Mount host log directories
    extraVolumes:
      - name: varlog
        hostPath:
          path: /var/log
      - name: varlibdockercontainers
        hostPath:
          path: /var/lib/docker/containers

    extraVolumeMounts:
      - name: varlog
        mountPath: /var/log
        readOnly: true
      - name: varlibdockercontainers
        mountPath: /var/lib/docker/containers
        readOnly: true
