---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: loki
  namespace: monitoring
spec:
  dependsOn:
    - name: traefik
      namespace: flux-system
  interval: 10m
  timeout: 15m # Extended timeout for initial deployment
  chart:
    spec:
      chart: loki
      version: "6.30.x" # Avoid 6.35+ due to S3 breaking changes
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
      interval: 5m

  install:
    createNamespace: false
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  rollback:
    recreate: true
    force: true

  values:
    # Deployment mode - SingleBinary for filesystem storage
    deploymentMode: SingleBinary

    # Loki configuration
    loki:
      auth_enabled: false

      # Critical: replication_factor must be 1 for single replica
      commonConfig:
        replication_factor: 1
        ring:
          kvstore:
            store: inmemory

      # Filesystem storage configuration
      storage:
        type: filesystem

      # Schema configuration - quoted dates prevent parsing issues
      schemaConfig:
        configs:
          - from: "2024-04-01" # Quoted to prevent Flux date conversion
            store: tsdb
            object_store: filesystem
            schema: v13
            index:
              prefix: loki_index_
              period: 24h

      # Limits configuration
      limits_config:
        retention_period: 168h # 7 days
        enforce_metric_name: false
        reject_old_samples: true
        reject_old_samples_max_age: 168h
        # Prevent excessive memory usage
        max_entries_limit_per_query: 5000
        max_streams_per_user: 10000
        max_global_streams_per_user: 10000

      # Compactor configuration for retention
      compactor:
        working_directory: /var/loki/compactor
        compaction_interval: 10m
        retention_enabled: true
        retention_delete_delay: 1h

    # SingleBinary specific configuration
    singleBinary:
      replicas: 1

      # Reasonable resource limits (avoid chart defaults)
      resources:
        limits:
          cpu: 500m
          memory: 1Gi
        requests:
          cpu: 250m
          memory: 512Mi

      # Persistence using NFS
      persistence:
        enabled: true
        size: 10Gi
        storageClass: nfs-holocron-general
        accessModes:
          - ReadWriteOnce
        enableStatefulSetAutoDeletePVC: false

      # Memory management
      extraEnv:
        - name: GOMEMLIMIT
          value: 900MiB

    # Explicitly disable other deployment modes to prevent validation errors
    backend:
      replicas: 0
    read:
      replicas: 0
    write:
      replicas: 0

    # Gateway configuration - avoid common issues
    gateway:
      enabled: true
      # Reduced resources (chart defaults are excessive)
      resources:
        limits:
          cpu: 100m
          memory: 128Mi
        requests:
          cpu: 50m
          memory: 64Mi

    # Disable MinIO completely for filesystem storage
    minio:
      enabled: false

    # Fix memcached excessive memory requests
    chunksCache:
      enabled: true
      allocatedMemory: 1024 # 1GB instead of 9.8GB default

    resultsCache:
      enabled: true
      allocatedMemory: 512 # 512MB instead of excessive default

    # ServiceMonitor - disable problematic self-monitoring
    monitoring:
      selfMonitoring:
        enabled: false # Avoids Grafana Agent Operator dependency
      serviceMonitor:
        enabled: true
        labels:
          app.kubernetes.io/part-of: monitoring-stack

    # Simplified ingress (avoid complex host/path structures)
    ingress:
      enabled: true
      ingressClassName: traefik
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-cloudflare
        traefik.ingress.kubernetes.io/router.entrypoints: websecure
        traefik.ingress.kubernetes.io/router.tls: "true"
      hosts:
        - loki.home.cwbtech.net
      tls:
        - secretName: loki-tls
          hosts:
            - loki.home.cwbtech.net

    # Disable problematic RBAC features
    rbac:
      pspEnabled: false # Avoid deprecated PodSecurityPolicy

    # Disable test pods
    test:
      enabled: false
