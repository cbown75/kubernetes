apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: loki
  namespace: monitoring
  labels:
    app.kubernetes.io/name: loki
    app.kubernetes.io/part-of: monitoring-stack
spec:
  interval: 10m
  timeout: 30m
  chart:
    spec:
      chart: loki
      version: "6.30.x"
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
      interval: 5m
  install:
    createNamespace: false
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  rollback:
    recreate: true
    force: true
  values:
    deploymentMode: SingleBinary
    loki:
      auth_enabled: false
      podSecurityContext:
        fsGroup: 10001
        runAsGroup: 10001
        runAsNonRoot: true
        runAsUser: 10001
        seccompProfile:
          type: RuntimeDefault
      containerSecurityContext:
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL
        readOnlyRootFilesystem: true
      server:
        http_listen_port: 3100
        grpc_listen_port: 9095
        http_server_read_timeout: 120s
        http_server_write_timeout: 120s
        http_server_idle_timeout: 120s
        grpc_server_max_recv_msg_size: 104857600
        grpc_server_max_send_msg_size: 104857600
      commonConfig:
        replication_factor: 1
        ring:
          kvstore:
            store: inmemory
      storage:
        type: filesystem
      schemaConfig:
        configs:
          - from: "2024-04-01"
            store: tsdb
            object_store: filesystem
            schema: v13
            index:
              prefix: loki_index_
              period: 24h
      distributor:
        ring:
          kvstore:
            store: inmemory
      ingester:
        chunk_idle_period: 1h
        chunk_block_size: 262144
        chunk_retain_period: 1m
        max_chunk_age: 1h
        flush_check_period: 30s
        flush_op_timeout: 120s
        wal:
          enabled: true
          dir: /var/loki/wal
          replay_memory_ceiling: 1GB
      limits_config:
        retention_period: 168h
        reject_old_samples: true
        reject_old_samples_max_age: 168h
        max_entries_limit_per_query: 5000
        max_streams_per_user: 10000
        max_global_streams_per_user: 10000
        ingestion_rate_mb: 10
        ingestion_burst_size_mb: 20
        per_stream_rate_limit: 5MB
        per_stream_rate_limit_burst: 15MB
        query_timeout: 120s
      compactor:
        working_directory: /var/loki/compactor
        compaction_interval: 10m
        retention_enabled: true
        retention_delete_delay: 1h
        delete_request_store: filesystem
    singleBinary:
      replicas: 1
      resources:
        limits:
          cpu: 1000m
          memory: 2Gi
        requests:
          cpu: 500m
          memory: 1Gi
      persistence:
        enabled: true
        size: 10Gi
        storageClass: nfs-holocron-general
        accessModes:
          - ReadWriteOnce
        enableStatefulSetAutoDeletePVC: false
      extraEnv:
        - name: GOMEMLIMIT
          value: 1800MiB
    backend:
      replicas: 0
    read:
      replicas: 0
    write:
      replicas: 0
    ingester:
      replicas: 0
    querier:
      replicas: 0
    queryFrontend:
      replicas: 0
    queryScheduler:
      replicas: 0
    distributor:
      replicas: 0
    compactor:
      replicas: 0
    indexGateway:
      replicas: 0
    bloomCompactor:
      replicas: 0
    bloomGateway:
      replicas: 0
    gateway:
      enabled: true
      resources:
        limits:
          cpu: 200m
          memory: 256Mi
        requests:
          cpu: 100m
          memory: 128Mi
      podSecurityContext:
        fsGroup: 101
        runAsGroup: 101
        runAsNonRoot: true
        runAsUser: 101
        seccompProfile:
          type: RuntimeDefault
      containerSecurityContext:
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL
        readOnlyRootFilesystem: true
      nginxConfig:
        httpSnippet: |
          client_body_timeout 120s;
          client_header_timeout 120s;
          send_timeout 120s;
          proxy_read_timeout 120s;
          proxy_connect_timeout 120s;
          proxy_send_timeout 120s;
    memcached:
      podSecurityContext:
        fsGroup: 11211
        runAsGroup: 11211
        runAsNonRoot: true
        runAsUser: 11211
        seccompProfile:
          type: RuntimeDefault
      containerSecurityContext:
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL
        readOnlyRootFilesystem: true
    minio:
      enabled: false
    chunksCache:
      enabled: true
      allocatedMemory: 1024
    resultsCache:
      enabled: true
      allocatedMemory: 512
    monitoring:
      selfMonitoring:
        enabled: false
      serviceMonitor:
        enabled: true
        labels:
          app.kubernetes.io/part-of: monitoring-stack
    rbac:
      pspEnabled: false
    test:
      enabled: false
