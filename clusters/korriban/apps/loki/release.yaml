---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: loki
  namespace: monitoring
spec:
  dependsOn:
    - name: traefik
      namespace: flux-system
  interval: 10m
  timeout: 15m
  chart:
    spec:
      chart: loki
      version: "6.30.x"
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
      interval: 5m

  install:
    createNamespace: false
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  rollback:
    recreate: true
    force: true

  values:
    # Deployment mode
    deploymentMode: SingleBinary

    # Global Loki configuration with enhanced security contexts
    loki:
      auth_enabled: false

      # Global Pod Security Context
      podSecurityContext:
        fsGroup: 10001
        runAsGroup: 10001
        runAsNonRoot: true
        runAsUser: 10001
        seccompProfile:
          type: RuntimeDefault

      # Global Container Security Context
      containerSecurityContext:
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL
        readOnlyRootFilesystem: true

      # Critical: replication_factor must be 1 for single replica
      commonConfig:
        replication_factor: 1
        ring:
          kvstore:
            store: inmemory

      # Filesystem storage configuration
      storage:
        type: filesystem

      # Schema configuration
      schemaConfig:
        configs:
          - from: "2024-04-01"
            store: tsdb
            object_store: filesystem
            schema: v13
            index:
              prefix: loki_index_
              period: 24h

      # Limits configuration
      limits_config:
        retention_period: 168h
        enforce_metric_name: false
        reject_old_samples: true
        reject_old_samples_max_age: 168h
        max_entries_limit_per_query: 5000
        max_streams_per_user: 10000
        max_global_streams_per_user: 10000

      # Compactor configuration for retention
      compactor:
        working_directory: /var/loki/compactor
        compaction_interval: 10m
        retention_enabled: true
        retention_delete_delay: 1h

    # SingleBinary specific configuration
    singleBinary:
      replicas: 1

      # Resource limits
      resources:
        limits:
          cpu: 500m
          memory: 1Gi
        requests:
          cpu: 250m
          memory: 512Mi

      # Persistence using NFS
      persistence:
        enabled: true
        size: 10Gi
        storageClass: nfs-holocron-general
        accessModes:
          - ReadWriteOnce
        enableStatefulSetAutoDeletePVC: false

      # Memory management
      extraEnv:
        - name: GOMEMLIMIT
          value: 900MiB

    # Explicitly disable other deployment modes
    backend:
      replicas: 0
    read:
      replicas: 0
    write:
      replicas: 0

    # Gateway configuration with enhanced security context
    gateway:
      enabled: true

      # Resource limits
      resources:
        limits:
          cpu: 100m
          memory: 128Mi
        requests:
          cpu: 50m
          memory: 64Mi

      # Gateway-specific security context
      podSecurityContext:
        fsGroup: 101
        runAsGroup: 101
        runAsNonRoot: true
        runAsUser: 101
        seccompProfile:
          type: RuntimeDefault

      containerSecurityContext:
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL
        readOnlyRootFilesystem: true

    # Memcached configuration with proper security contexts
    memcached:
      # Security context for memcached processes
      podSecurityContext:
        fsGroup: 11211
        runAsGroup: 11211
        runAsNonRoot: true
        runAsUser: 11211
        seccompProfile:
          type: RuntimeDefault

      containerSecurityContext:
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL
        readOnlyRootFilesystem: true

    # Disable MinIO for filesystem storage
    minio:
      enabled: false

    # Cache configuration
    chunksCache:
      enabled: true
      allocatedMemory: 1024

    resultsCache:
      enabled: true
      allocatedMemory: 512

    # ServiceMonitor configuration
    monitoring:
      selfMonitoring:
        enabled: false
      serviceMonitor:
        enabled: true
        labels:
          app.kubernetes.io/part-of: monitoring-stack

    # Ingress configuration
    ingress:
      enabled: true
      ingressClassName: traefik
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-cloudflare
        traefik.ingress.kubernetes.io/router.entrypoints: websecure
        traefik.ingress.kubernetes.io/router.tls: "true"
      hosts:
        - loki.home.cwbtech.net
      tls:
        - secretName: loki-tls
          hosts:
            - loki.home.cwbtech.net

    # RBAC configuration
    rbac:
      pspEnabled: false

    # Disable test pods
    test:
      enabled: false
