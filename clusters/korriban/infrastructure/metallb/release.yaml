---
apiVersion: v1
kind: Namespace
metadata:
  name: metallb-system
  labels:
    name: metallb-system
    app.kubernetes.io/name: metallb
    app.kubernetes.io/part-of: metallb
    # Required for MetalLB speaker to manipulate network settings
    pod-security.kubernetes.io/enforce: privileged
    pod-security.kubernetes.io/audit: privileged
    pod-security.kubernetes.io/warn: privileged
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: metallb
  namespace: flux-system
spec:
  interval: 24h
  url: https://metallb.github.io/metallb
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: metallb
  namespace: metallb-system
  labels:
    app.kubernetes.io/name: metallb
    app.kubernetes.io/part-of: metallb
spec:
  targetNamespace: metallb-system
  interval: 15m
  timeout: 10m
  chart:
    spec:
      chart: metallb
      version: "0.14.8"
      reconcileStrategy: Revision
      sourceRef:
        kind: HelmRepository
        name: metallb
        namespace: flux-system
      interval: 5m

  install:
    createNamespace: true
    crds: CreateReplace
    remediation:
      retries: 3

  upgrade:
    crds: CreateReplace
    remediation:
      retries: 3

  rollback:
    recreate: true
    force: true

  values:
    # Controller configuration
    controller:
      enabled: true
      image:
        repository: quay.io/metallb/controller
        tag: v0.14.8
        pullPolicy: IfNotPresent

      # Production logging level
      logLevel: warn

      # Resource limits for production
      resources:
        limits:
          cpu: 100m
          memory: 100Mi
        requests:
          cpu: 50m
          memory: 50Mi

      # Security context
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
        fsGroup: 65534
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL
        readOnlyRootFilesystem: true
        seccompProfile:
          type: RuntimeDefault

    # Speaker configuration
    speaker:
      enabled: true
      image:
        repository: quay.io/metallb/speaker
        tag: v0.14.8
        pullPolicy: IfNotPresent

      # Production logging level
      logLevel: warn

      # Resource limits for production
      resources:
        limits:
          cpu: 100m
          memory: 128Mi
        requests:
          cpu: 50m
          memory: 64Mi

      # Tolerations for all nodes including control plane
      tolerations:
        - effect: NoSchedule
          operator: Exists
        - effect: NoExecute
          operator: Exists

      # Security context - speaker needs elevated privileges
      securityContext:
        runAsUser: 0
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: true
        capabilities:
          add:
            - NET_RAW
            - NET_ADMIN
          drop:
            - ALL

    # Prometheus monitoring
    prometheus:
      namespace: monitoring
      serviceAccount: metallb-controller
      app.kubernetes.io/part-of: monitoring-stack
      serviceMonitor:
        enabled: true
        additionalLabels:
          app.kubernetes.io/part-of: monitoring-stack
      prometheusRule:
        enabled: true
        additionalLabels:
          app.kubernetes.io/part-of: monitoring-stack

    # CRD management
    crds:
      enabled: true
      validationFailurePolicy: Fail

    # FRR mode disabled (using L2 mode)
    frrk8s:
      enabled: false
