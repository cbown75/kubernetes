{{- if .Values.installCRDs }}
# First, create a ConfigMap containing the CRDs
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "fluxcd.fullname" . }}-crds
  labels:
    {{- include "fluxcd.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-6"
    "helm.sh/hook-delete-policy": hook-succeeded
data:
  gitrepositories.yaml: |-
{{ .Files.Get "crds/gitrepositories.yaml" | indent 4 }}
  kustomizations.yaml: |-
{{ .Files.Get "crds/kustomizations.yaml" | indent 4 }}
  alerts.yaml: |-
{{ .Files.Get "crds/alerts.yaml" | indent 4 }}
  providers.yaml: |-
{{ .Files.Get "crds/providers.yaml" | indent 4 }}
---
# Then create the Job that applies the CRDs
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "fluxcd.fullname" . }}-install-crds
  labels:
    {{- include "fluxcd.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  template:
    spec:
      # Add pod-level security context
      securityContext:
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault
      serviceAccountName: {{ .Values.rbac.serviceAccountName }}
      restartPolicy: OnFailure
      containers:
        - name: kubectl
          # Add container-level security context
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]
            runAsNonRoot: true
          image: bitnami/kubectl:latest
          command:
            - /bin/sh
            - -c
            - |
              kubectl apply -f /crds/gitrepositories.yaml
              kubectl apply -f /crds/kustomizations.yaml  
              kubectl apply -f /crds/alerts.yaml
              kubectl apply -f /crds/providers.yaml
          volumeMounts:
            - name: crds-volume
              mountPath: /crds
      volumes:
        - name: crds-volume
          configMap:
            name: {{ include "fluxcd.fullname" . }}-crds
{{- end }}
