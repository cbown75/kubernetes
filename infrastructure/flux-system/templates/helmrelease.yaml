apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: {{ .Values.flux.helmRelease.name }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "flux-system.labels" . | nindent 4 }}
spec:
  interval: 10m
  timeout: 5m
  chart:
    spec:
      chart: {{ .Values.flux.helmRelease.chart }}
      version: {{ .Values.flux.helmRelease.version | quote }}
      sourceRef:
        kind: HelmRepository
        name: {{ .Values.flux.helmRepository.name }}
        namespace: {{ .Release.Namespace }}
      interval: 5m
  
  install:
    createNamespace: true
    remediation:
      retries: 3
  
  upgrade:
    remediation:
      retries: 3
  
  values:
    {{- toYaml .Values.flux.helmRelease.values | nindent 4 }}

---
{{- if .Values.gitRepository }}
apiVersion: source.toolkit.fluxcd.io/v1
kind: GitRepository
metadata:
  name: {{ .Values.gitRepository.name }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "flux-system.labels" . | nindent 4 }}
spec:
  interval: {{ .Values.gitRepository.interval }}
  url: {{ .Values.gitRepository.url }}
  ref:
    branch: {{ .Values.gitRepository.branch }}
  {{- if .Values.gitRepository.secretRef }}
  secretRef:
    name: {{ .Values.gitRepository.secretRef.name }}
  {{- end }}

---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: {{ .Values.kustomization.name }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "flux-system.labels" . | nindent 4 }}
spec:
  interval: {{ .Values.kustomization.interval }}
  path: {{ .Values.kustomization.path | quote }}
  prune: {{ .Values.kustomization.prune }}
  sourceRef:
    kind: GitRepository
    name: {{ .Values.gitRepository.name }}
{{- end }}
