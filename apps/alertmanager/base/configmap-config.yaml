apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: monitoring
data:
  alertmanager.yml: |
    global:
      resolve_timeout: 5m

    route:
      receiver: "default"
      group_by: ["alertname", "cluster", "service"]
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h
      routes:
        # Critical alerts - immediate notification
        - matchers:
            - severity="critical"
          receiver: "critical"
          group_wait: 10s
          repeat_interval: 1h
          continue: true
        # Warning alerts - grouped notifications
        - matchers:
            - severity="warning"
          receiver: "warning"
          group_wait: 2m
          repeat_interval: 12h
        # Infrastructure alerts
        - matchers:
            - alertname=~"Node.*|Disk.*|Memory.*|CPU.*"
          receiver: "infrastructure"
          group_by: ["alertname", "instance"]
        # Application alerts
        - matchers:
            - alertname=~"Pod.*|Container.*|Service.*"
          receiver: "application"
          group_by: ["alertname", "namespace", "pod"]

    receivers:
      - name: "default"
        webhook_configs:
          - url: "http://webhook-receiver.monitoring.svc.cluster.local:8080/alerts"
            send_resolved: true
      - name: "critical"
        slack_configs:
          - api_url_file: "/etc/alertmanager/secrets/slack-webhook-url"
            channel: "#home-critical"
            title: "üö® CRITICAL Alert"
            text: "{{ range .Alerts }}{{ .Annotations.description }}{{ end }}"
            color: "danger"
            send_resolved: true
        webhook_configs:
          - url: "http://webhook-receiver.monitoring.svc.cluster.local:8080/critical"
            send_resolved: true
            http_config:
              basic_auth:
                username: "alertmanager"
                password_file: "/etc/alertmanager/secrets/webhook-password"
      - name: "warning"
        slack_configs:
          - api_url_file: "/etc/alertmanager/secrets/slack-webhook-url"
            channel: "#home-alerts"
            title: "‚ö†Ô∏è Warning Alert"
            color: "warning"
            send_resolved: true
        webhook_configs:
          - url: "http://webhook-receiver.monitoring.svc.cluster.local:8080/warning"
            send_resolved: true
      - name: "infrastructure"
        slack_configs:
          - api_url_file: "/etc/alertmanager/secrets/slack-webhook-url"
            channel: "#home-infrastructure"
            title: "üîß Infrastructure Alert"
            color: "warning"
            send_resolved: true
        webhook_configs:
          - url: "http://webhook-receiver.monitoring.svc.cluster.local:8080/infrastructure"
            send_resolved: true
      - name: "application"
        slack_configs:
          - api_url_file: "/etc/alertmanager/secrets/slack-webhook-url"
            channel: "#home-applications"
            title: "üì¶ Application Alert"
            color: "warning"
            send_resolved: true
        webhook_configs:
          - url: "http://webhook-receiver.monitoring.svc.cluster.local:8080/application"
            send_resolved: true

    inhibit_rules:
      # Inhibit warning alerts when critical alerts are firing
      - source_matchers:
          - severity="critical"
        target_matchers:
          - severity="warning"
        equal: ["alertname", "cluster", "service"]
