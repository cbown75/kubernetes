apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: oncall
  namespace: oncall
  labels:
    app.kubernetes.io/name: oncall
    app.kubernetes.io/part-of: monitoring-stack
spec:
  interval: 10m
  timeout: 15m
  chart:
    spec:
      chart: oncall
      version: ">=1.0.0"
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
      interval: 5m
  install:
    createNamespace: false
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
      remediateLastFailure: true
  rollback:
    cleanupOnFail: true
    force: true
    recreate: true
  values:
    # Base URL configuration - will be patched by overlay
    base_url: oncall.home.cwbtech.net
    base_url_protocol: https

    # Disable built-in ingress - using Istio
    ingress:
      enabled: false

    # Disable built-in nginx ingress controller
    ingress-nginx:
      enabled: false

    # Disable built-in cert-manager
    cert-manager:
      enabled: false

    # Use external Grafana
    grafana:
      enabled: false

    externalGrafana:
      url: http://grafana.monitoring.svc.cluster.local:80

    # Database configuration - use external PostgreSQL
    database:
      type: postgresql

    # External PostgreSQL connection
    externalPostgresql:
      host: postgres.home.cwbtech.net
      port: 5432
      db: oncall
      user: oncall
      existingSecret: oncall-postgresql
      passwordKey: password

    # OnCall engine configuration
    oncall:
      replicaCount: 1
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi

    # Celery workers for async tasks
    celery:
      replicaCount: 1
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi

    # MariaDB disabled - using external PostgreSQL instead
    mariadb:
      enabled: false

    # RabbitMQ for message broker - using official Docker Hub image
    # Note: Official image ignores Bitnami's RABBITMQ_USERNAME/PASSWORD env vars
    # Must use RABBITMQ_DEFAULT_USER/PASS via extraEnvVars instead
    rabbitmq:
      enabled: true
      image:
        registry: docker.io
        repository: rabbitmq
        tag: "4.2-management"
      auth:
        username: user
        existingPasswordSecret: oncall-rabbitmq
        existingErlangSecret: oncall-rabbitmq
      # Official RabbitMQ image needs RABBITMQ_DEFAULT_USER/PASS (not RABBITMQ_USERNAME)
      extraEnvVars:
        - name: RABBITMQ_DEFAULT_USER
          value: "user"
        - name: RABBITMQ_DEFAULT_PASS
          valueFrom:
            secretKeyRef:
              name: oncall-rabbitmq
              key: rabbitmq-password
      persistence:
        enabled: true
        size: 2Gi
        storageClass: PLACEHOLDER
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
      # Override probes to use rabbitmq-diagnostics instead of curl
      livenessProbe:
        enabled: false
      readinessProbe:
        enabled: false
      customLivenessProbe:
        exec:
          command:
            - rabbitmq-diagnostics
            - -q
            - check_running
        initialDelaySeconds: 120
        periodSeconds: 30
        timeoutSeconds: 20
        failureThreshold: 6
      customReadinessProbe:
        exec:
          command:
            - rabbitmq-diagnostics
            - -q
            - ping
        initialDelaySeconds: 10
        periodSeconds: 30
        timeoutSeconds: 20
        failureThreshold: 3

    # Redis for caching - using official Docker Hub image
    # Note: non-alpine because Bitnami chart scripts require /bin/bash
    redis:
      enabled: true
      image:
        registry: docker.io
        repository: redis
        tag: "8"
      architecture: standalone
      auth:
        enabled: true
        existingSecret: oncall-redis
        existingSecretPasswordKey: redis-password
      master:
        persistence:
          enabled: true
          size: 2Gi
          storageClass: PLACEHOLDER
        resources:
          requests:
            cpu: 50m
            memory: 128Mi
          limits:
            cpu: 250m
            memory: 256Mi
