{{- if .Values.sealedSecrets.enabled }}
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: {{ include "nebula-sync-pihole1.fullname" . }}-secrets
  labels:
    {{- include "nebula-sync-pihole1.labels" . | nindent 4 }}
spec:
  # FIXED: Store context before entering nested structures
  {{- $fullName := include "nebula-sync-pihole1.fullname" . -}}
  {{- $namespace := .Release.Namespace -}}
  
  encryptedData:
    # Primary password
    primary-password: {{ .Values.sealedSecrets.primaryPassword }}
    
    # FIXED: Replica passwords with proper context handling
    {{- range $index, $encryptedPassword := .Values.sealedSecrets.replicaPasswords }}
    replica-password-{{ $index }}: {{ $encryptedPassword }}
    {{- end }}
    
    # FIXED: Additional secrets with context preservation
    {{- range $key, $value := .Values.sealedSecrets.additionalSecrets }}
    {{ $key }}: {{ $value }}
    {{- end }}
    
  template:
    type: Opaque
    metadata:
      name: {{ $fullName }}-secrets
      namespace: {{ $namespace }}
      labels:
        {{- include "nebula-sync-pihole1.labels" $ | nindent 8 }}
{{- end }}
